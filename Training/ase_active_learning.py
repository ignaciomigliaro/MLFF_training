from ase.io import read
import os
import argparse
from chgnet.model.dynamics import CHGNetCalculator
"""
This code is for running an agnostic active learning workflow that works on any MLFF that has an ASE calculator and configuration space generated by molecular dynamics. 
The idea is to have a general workflow that can be used to benchmark any MLFF.
"""

# A dictionary to map calculator names to actual ASE calculator classes
CALCULATOR_MAP = {
    'ALIGNN': 'alignn.ase.ALIGNN',  # String representation of the import path
    'CHGnet': 'chgnet.ase.CHGNet',
    'DEEPMD-kit': 'deepmd.ase.DeepMD',
    'MG3NET': 'mg3net.ase.MG3Net',
    'MACE': 'mace.ase.MACE',
}

def parse_arguments():
    """
    Parses command-line arguments for the script.

    Returns:
    - args: The parsed arguments object with attributes for each argument.
    """
    parser = argparse.ArgumentParser(description="Read configurations and choose a calculator for ASE.")
    
    parser.add_argument(
        "path",
        type=str,
        help="Path to a file or directory containing the configuration files."
    )
    
    parser.add_argument(
        "--calculator",
        type=str,
        choices=CALCULATOR_MAP.keys(),
        required=True,
        help="Choose a calculator: ALIGNN, CHGnet, DEEPMD-kit, MG3NET, MACE."
    )

    parser.add_argument(
        "--stepsize",
        type=int,
        default=1,
        help="Step size for subsampling configurations (default: 1)."
    )
    parser.add_argument(
        "--model_dir",
        type=str,
        required=True,
        help="Path to the directory containing model files."
    )
    return parser.parse_args()

def get_configuration_space(path, stepsize):
    """
    Reads configurations from a file or all files in a directory using ASE's read function.

    Parameters:
    - path (str): The path to a file or directory. If a directory, all files inside will be read.
    - stepsize (int): The step size for subsampling configurations.

    Returns:
    - configurations (list): A list of ASE Atoms objects representing different configurations.
    """
    configurations = []

    if os.path.isfile(path):
        # If it's a single file, read all configurations from that file
        all_atoms = read(path, index=':')
        configurations = all_atoms[::stepsize]  # Subsample using the stepsize
    elif os.path.isdir(path):
        # If it's a directory, iterate through all files
        for filename in os.listdir(path):
            file_path = os.path.join(path, filename)
            if os.path.isfile(file_path):
                # Read configurations from each file and subsample
                all_atoms = read(file_path, index=':')
                configurations.extend(all_atoms[::stepsize])  # Subsample using the stepsize
    else:
        raise ValueError(f"The provided path '{path}' is neither a file nor a directory.")
    
    return configurations

def load_models_from_directory(model_dir):
    """
    Loads all models from the specified directory.

    Parameters:
    - model_dir (str): Path to the directory containing model files.

    Returns:
    - models (list): A list of loaded models.
    """
    models = []
    for filename in os.listdir(model_dir):
            model_path = os.path.join(model_dir, filename)
            models.append(model_path)
    return models

def set_calculator(atoms_list, calculator_name):
    """
    Sets the calculator for a list of ASE Atoms objects based on user input.

    Parameters:
    - atoms_list (list): List of ASE Atoms objects.
    - calculator_name (str): The name of the calculator to use.

    Returns:
    - updated_atoms_list (list): List of ASE Atoms objects with the calculator set.
    """
    # Import the selected calculator dynamically
    
    
    # Apply the calculator to each Atoms object in the list
    for atoms in atoms_list:
        atoms.set_calculator(CalculatorClass())
    
    return atoms_list

def main():
    """
    Main function to handle the workflow.
    """
    # Parse command-line arguments
    args = parse_arguments()
    
    # Read configurations from the provided path with the specified stepsize
    configurations = get_configuration_space(args.path, args.stepsize)
    
    # Print the number of configurations loaded
    print(f"Total configurations loaded: {len(configurations)}")
    
    # Set the chosen calculator for all configurations
    configurations = set_calculator(configurations, args.calculator)
    
    # Print the calculator used
    print(f"Calculator set to: {args.calculator}")

if __name__ == "__main__":
    main()